---
title: "01 Read"
output: html_notebook
---

The following notebook creates the processed data that is used in the analysis.

In the first section, it conbines the raw search results downloaded from GDrive. These are not uploaded to Github due to the size. 

The second section processes the keywords file. The `search_results` are used to only keep `keywords` that were found in all four search engines. There are ~400 (out of 60k) that are therefore excluded.

# Read in and process raw search results

```{r}
library(tidyverse)
```

```{r}
## function to create rds files of the data
tictoc::tic() # < 3 mins
create_rds_from_raw_file <- function(search_engine) {
  
  ## the delim for DuckDuck is different to the rest
  if (search_engine == "DuckDuck") {
    csv_delim <-  "\t"
    csv_colnames <- TRUE
  } else {
    csv_delim <- "~"
    csv_colnames <- c("entry_id", "keyword_id", "keyword", "type", "rank_group",
                          "rank_absolute","page_num", "domain", "title", "url", "breadcrumb",
                          "meta", "meta_2", "meta_3")
    # csv_colnames <- str_c("col_", 1:40)
  }
  
  list_of_files <- list.files(here::here(str_c("raw_data/download_from_gdrive/", search_engine)))
  
  map_dfr(list_of_files,
          ~read_delim(
            here::here(str_c("raw_data/download_from_gdrive/", search_engine, "/", .)),
            delim = csv_delim,
            col_names = csv_colnames,
            escape_double = F,
            escape_backslash = F,
            col_types = cols(.default = col_character()),
            n_max = 999999
            ) 
          ) %>% 
    mutate(search_engine = search_engine)
}

search_results <- map_dfr(c("Google", "Bing", "Yahoo", "DuckDuck"),
                          ~create_rds_from_raw_file(.))

search_results %>% 
  glimpse()

write_rds(search_results, here::here("proc_data/search_results.rds"))
tictoc::toc()
```




# Keywords

```{r}
# keywords <- read_rds(here::here("raw_data/keywords_120k.rds"))
keywords <- read_csv(here::here("raw_data/download_from_gdrive/keywords_60k.csv"))
```



So need to be careful about the dominoes pizza search result. Honestly, may be esier tojust remove this. keyword 3733



I can simply check which of these are in all the stuff

```{r}
keywords %>% 
  select(keyword, keyword_id) %>% 
  left_join(
    search_results %>% 
      filter(search_engine == "Google") %>% 
      distinct(keyword, .keep_all = T) %>% 
      mutate(google = TRUE) %>% 
      select(keyword, google),
    by = "keyword"
  ) %>% 
  
  left_join(
    search_results %>% 
      filter(search_engine == "Yahoo") %>% 
      distinct(keyword, .keep_all = T) %>% 
      mutate(yahoo = TRUE) %>% 
      select(keyword, yahoo),
    by = "keyword"
  ) %>% 

left_join(
    search_results %>% 
      filter(search_engine == "DuckDuck") %>% 
      distinct(keyword, .keep_all = T) %>% 
      mutate(duckduck = TRUE) %>% 
      select(keyword, duckduck),
    by = "keyword"
  ) %>% 

left_join(
    search_results %>% 
      filter(search_engine == "Bing") %>% 
      distinct(keyword, .keep_all = T) %>% 
      mutate(bing = TRUE) %>% 
      select(keyword, bing),
    by = "keyword"
  ) %>% 
  # head(100)
  group_by(google, bing, yahoo, duckduck) %>%
  mutate(rn = row_number()) %>%
  # filter(rn <= 5) %>%
  arrange(desc(google), desc(yahoo), desc(duckduck), desc(bing)) %>% 
  filter(google, yahoo, duckduck, bing,
         !keyword %in% c("the rolling stones ",
                         "4th of july ",
                         "let's dance ")) %>% 
  ungroup() %>% 
  select(-google, -yahoo, -duckduck, -bing) %>% 
  inner_join(
    keywords,
    by = c("keyword", "keyword_id")
  ) %>% 
  write_rds(here::here("proc_data/keywords.rds"))
%>% 
  # write_csv(here::here("raw_data/missing_keywords.csv"))
  summarise(n = n_distinct(keyword))
  
```



